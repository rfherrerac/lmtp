
context("Fidelity of estimators for a point treatment")

# data generation
set.seed(429153)
n_obs <- 1000
W <- replicate(2, rbinom(n_obs, 1, 0.5))
A <- rnorm(n_obs, mean = 2 * W, sd = 1)
Y <- rbinom(n_obs, 1, plogis(A + W + rnorm(n_obs, mean = 0, sd = 1)))
nodes <- list(c("X1", "X2"))
df <- data.frame(W, A, Y)
truth <- 0.76451
lrnrs <- list(sl3::make_learner(sl3::Lrnr_glm))

# estimators
sub <-
  lmtp_sub(df, "A", "Y", nodes, shift = function(x) x + 0.5,
           outcome_type = "binomial", learners = lrnrs, folds = 5)

ipw <-
  lmtp_ipw(df, "A", "Y", nodes, shift = function(x) x + 0.5,
           learners = lrnrs, folds = 5)

tmle <-
  lmtp_tmle(df, "A", "Y", nodes, shift = function(x) x + 0.5,
            outcome_type = "binomial",
            learners_outcome = lrnrs,
            learners_trt = lrnrs, folds = 5)

sdr <-
  lmtp_sdr(df, "A", "Y", nodes, shift = function(x) x + 0.5,
           outcome_type = "binomial",
           learners_outcome = lrnrs,
           learners_trt = lrnrs, folds = 5)

# tests
test_that("point treatment fidelity", {
  expect_equal(truth, sub$theta, tolerance = 0.1)
  expect_equal(truth, ipw$theta, tolerance = 0.1)
  expect_equal(truth, tmle$theta, tolerance = 0.1)
  expect_equal(truth, sdr$theta, tolerance = 0.1)
})
